<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GALAXY DEFENDER: UNIVERSAL</title>
    <style>
        body {
            margin: 0;
            background-color: #050505;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }
        canvas {
            display: block;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* STATS */
        #top-bar {
            padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none;
        }
        .stat-box { font-size: 18px; color: #fff; text-shadow: 1px 1px 0 #000; font-weight: bold; margin-bottom: 5px; }
        #frozen-msg { color: #0ff; font-weight: bold; display: none; text-shadow: 0 0 10px #0ff; font-size: 20px; animation: blink 0.5s infinite; }
        #powerup-msg { color: #ff0; font-weight: bold; display: none; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* PAUSE BUTTON */
        #pause-btn {
            pointer-events: auto; background: rgba(255, 255, 255, 0.2); border: 2px solid #fff;
            color: #fff; font-weight: bold; padding: 10px 15px; border-radius: 5px; cursor: pointer; backdrop-filter: blur(4px);
        }

        /* SCREENS */
        #start-screen, #pause-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 20; pointer-events: auto;
        }
        #pause-screen { display: none; background: rgba(0,0,0,0.6); z-index: 15; }
        
        h1 { color: #00d2ff; font-size: 40px; text-transform: uppercase; margin-bottom: 10px; text-align: center; }
        p { color: #ddd; font-size: 16px; max-width: 80%; text-align: center; line-height: 1.5; }
        
        button.start-btn {
            margin-top: 30px; padding: 15px 50px; font-size: 24px;
            background: #00d2ff; border: none; color: #000; font-weight: bold;
            border-radius: 30px; box-shadow: 0 0 20px #00d2ff; cursor: pointer;
        }

        .paused-text { font-size: 50px; color: #fff; font-weight: bold; letter-spacing: 5px; }

        /* MOBILE CONTROLS (Only visible on touch devices usually, but forced block for consistency here if needed) */
        #mobile-controls {
            display: none; 
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none;
        }
        @media (pointer: coarse) { #mobile-controls { display: block; } }

        /* JOYSTICK */
        .joystick-area {
            position: absolute; bottom: 40px; left: 40px; width: 150px; height: 150px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; pointer-events: auto; touch-action: none;
        }
        .stick {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(0, 210, 255, 0.5); border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 10px #00d2ff; pointer-events: none;
        }

        /* BUTTONS */
        .action-area {
            position: absolute; bottom: 40px; right: 40px; display: flex; gap: 20px; align-items: flex-end; pointer-events: none;
        }
        .btn-touch {
            pointer-events: auto; border-radius: 50%; color: white; font-weight: bold;
            display: flex; align-items: center; justify-content: center; user-select: none;
            touch-action: none; border: 2px solid rgba(255,255,255,0.5); backdrop-filter: blur(4px);
        }
        .btn-shoot { width: 90px; height: 90px; background: rgba(255, 69, 0, 0.4); font-size: 18px; }
        .btn-shoot:active { background: rgba(255, 69, 0, 0.8); }
        .btn-warp { width: 60px; height: 60px; background: rgba(0, 210, 255, 0.4); font-size: 14px; margin-bottom: 15px; }
        .btn-warp:active { background: rgba(0, 210, 255, 0.8); }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>Galaxy Defender</h1>
        <p>
            <b>Laptop:</b> Arrow Keys to Move, Space to Shoot, Shift to Warp.<br>
            <b>Mobile:</b> Use On-Screen Joystick & Buttons.
        </p>
        <button class="start-btn" onclick="startGame()">PLAY GAME</button>
    </div>

    <div id="pause-screen">
        <div class="paused-text">PAUSED</div>
        <button class="start-btn" style="margin-top: 20px; font-size: 18px;" onclick="togglePause()">RESUME</button>
    </div>

    <div id="ui-layer">
        <div id="top-bar">
            <div>
                <div class="stat-box">Score: <span id="scoreEl">0</span></div>
                <div class="stat-box">Lives: <span id="livesEl">3</span></div>
                <div id="frozen-msg">❄️ FROZEN! ❄️</div>
                <div id="powerup-msg">TRIPLE SHOT!</div>
            </div>
            <button id="pause-btn" onclick="togglePause()">❚❚ PAUSE</button>
        </div>

        <div id="mobile-controls">
            <div class="joystick-area" id="joystick"><div class="stick" id="stick"></div></div>
            <div class="action-area">
                <div class="btn-touch btn-warp" id="btn-warp">WARP</div>
                <div class="btn-touch btn-shoot" id="btn-shoot">FIRE</div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    /** --- ASSETS --- */
    const SHIP_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M32 2 L42 22 L62 36 L42 42 L42 54 L32 62 L22 54 L22 42 L2 36 L22 22 Z" fill="#e0e0e0" stroke="#333" stroke-width="2"/><path d="M32 2 L32 62" stroke="#999" stroke-width="1"/><path d="M22 42 L10 38 L22 28 Z" fill="#ff4500"/><path d="M42 42 L54 38 L42 28 Z" fill="#ff4500"/><circle cx="32" cy="28" r="4" fill="#00d2ff"/></svg>`;
    const ROID_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path d="M10 20 L25 5 L45 10 L60 30 L50 55 L20 60 L5 40 Z" fill="#555" stroke="#222" stroke-width="2"/><path d="M15 25 L30 20 L25 40 Z" fill="#444"/><path d="M40 35 L50 45 L55 25 Z" fill="#333"/></svg>`;
    const UFO_SVG  = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><ellipse cx="32" cy="32" rx="30" ry="12" fill="#d00" stroke="#fff" stroke-width="2"/><ellipse cx="32" cy="25" rx="15" ry="12" fill="#f00" stroke="#500" stroke-width="2"/><circle cx="15" cy="32" r="3" fill="#ff0"/><circle cx="32" cy="32" r="3" fill="#ff0"/><circle cx="49" cy="32" r="3" fill="#ff0"/></svg>`;
    
    function svgToImg(svgString) {
        const img = new Image();
        const blob = new Blob([svgString], {type: 'image/svg+xml'});
        img.src = URL.createObjectURL(blob);
        return img;
    }

    /* AUDIO SYSTEM */
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let actx;
    function initAudio() { if(!actx) actx = new AudioContext(); if(actx.state === 'suspended') actx.resume(); }
    function playSound(type) {
        if (!actx) return;
        const osc = actx.createOscillator();
        const gain = actx.createGain();
        osc.connect(gain); gain.connect(actx.destination);
        const now = actx.currentTime;
        if (type === 'shoot') {
            osc.type = 'square'; osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(110, now + 0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'thrust') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'bang') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
            gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        } else if (type === 'powerup') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'hyperspace') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3);
            gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.3);
        }
    }

    /* GAME CONSTANTS */
    const FPS = 60;
    const FRICTION = 0.7;
    const SHIP_SIZE = 40;
    const TURN_SPEED = 360;
    const THRUST = 5;
    const LASER_SPD = 600;
    const ROID_SPD = 50;
    const GAME_LIVES = 3;
    const SHIP_INV_DUR = 3; 

    /* SETUP */
    const canv = document.getElementById("gameCanvas");
    const ctx = canv.getContext("2d");
    const shipImg = svgToImg(SHIP_SVG);
    const roidImg = svgToImg(ROID_SVG);
    const ufoImg = svgToImg(UFO_SVG);

    /* STATE VARIABLES */
    let level, roids, ship, ufo, score, lives, stars, particles, powerups;
    let gameRunning = false;
    let paused = false;
    let frameCount = 0;

    // --- UNIFIED INPUT SYSTEM ---
    const input = { left: false, right: false, up: false, down: false };

    /* EVENT LISTENERS */
    document.addEventListener("keydown", (ev) => {
        if(!gameRunning) return;
        switch(ev.keyCode) {
            case 37: input.left = true; break; // Left Arrow
            case 39: input.right = true; break; // Right Arrow
            case 38: input.up = true; break; // Up Arrow
            case 40: input.down = true; break; // Down Arrow
            case 32: shootLaser(); break; // Space
            case 16: hyperSpace(); break; // Shift
            case 80: togglePause(); break; // P
            case 13: if(ship.dead) newGame(); break; // Enter
        }
    });

    document.addEventListener("keyup", (ev) => {
        if(!gameRunning) return;
        switch(ev.keyCode) {
            case 37: input.left = false; break;
            case 39: input.right = false; break;
            case 38: input.up = false; break;
            case 40: input.down = false; break;
        }
    });

    // JOYSTICK LOGIC
    const joystick = document.getElementById("joystick");
    const stick = document.getElementById("stick");
    let stickDrag = false;

    joystick.addEventListener('touchstart', startStick, {passive: false});
    joystick.addEventListener('touchmove', moveStick, {passive: false});
    joystick.addEventListener('touchend', endStick, {passive: false});

    function startStick(e) { stickDrag = true; moveStick(e); }
    function moveStick(e) {
        if(!stickDrag) return;
        e.preventDefault();
        const rect = joystick.getBoundingClientRect();
        const touch = e.targetTouches[0];
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        let dx = touch.clientX - cx;
        let dy = touch.clientY - cy;
        
        const dist = Math.sqrt(dx*dx + dy*dy);
        const maxDist = 35; 
        if(dist > maxDist) { dx *= maxDist/dist; dy *= maxDist/dist; }
        stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

        // Update unified inputs from Touch
        input.right = dx > 10;
        input.left = dx < -10;
        input.up = dy < -10;
        input.down = dy > 10;
    }
    function endStick(e) {
        stickDrag = false;
        stick.style.transform = `translate(-50%, -50%)`;
        // Reset joystick inputs only, so keyboard doesn't get stuck if used simultaneously
        if(!stickDrag) {
            // Only reset if keys aren't pressed? 
            // Simplified: Touch release clears flags. Keyboard listeners re-assert them if keys held.
            // But to be safe, let's just clear the "touch" contribution. 
            // For simplicity in this engine: release stick = stop stick movement.
            // NOTE: If using mixed inputs, joystick release might stop key movement. 
            // Ideally separate sources, but for simple fix:
            input.left = input.right = input.up = input.down = false;
        }
    }

    // Touch Buttons
    document.getElementById("btn-shoot").addEventListener('touchstart', (e) => { e.preventDefault(); shootLaser(); }, {passive: false});
    document.getElementById("btn-warp").addEventListener('touchstart', (e) => { e.preventDefault(); hyperSpace(); }, {passive: false});


    function startGame() {
        document.getElementById("start-screen").style.display = "none";
        document.getElementById("ui-layer").style.display = "flex";
        initAudio();
        resizeCanvas();
        gameRunning = true;
        paused = false;
        newGame();
    }

    function togglePause() {
        if(!gameRunning) return;
        paused = !paused;
        const pScreen = document.getElementById("pause-screen");
        const pBtn = document.getElementById("pause-btn");
        if(paused) { pScreen.style.display = "flex"; pBtn.style.display = "none"; } 
        else { pScreen.style.display = "none"; pBtn.style.display = "block"; requestAnimationFrame(update); }
    }

    function newGame() {
        level = 0; lives = GAME_LIVES; score = 0;
        ship = newShip();
        ufo = { active: false, x: 0, y: 0, xv: 0, yv: 0, timer: 0, bullets: [] };
        createAsteroidBelt();
        particles = []; powerups = [];
        updateScore();
        document.getElementById("livesEl").innerText = lives;
        requestAnimationFrame(update);
    }

    function newShip() {
        return {
            x: canv.width / 2, y: canv.height / 2,
            a: 270 / 180 * Math.PI,
            r: SHIP_SIZE / 2, rot: 0,
            thrusting: false, reversing: false, thrust: { x: 0, y: 0 },
            canShoot: true, lasers: [], dead: false,
            blinkNum: Math.ceil(SHIP_INV_DUR / 0.1), blinkTime: Math.ceil(0.1 * FPS),
            frozen: false, freezeTimer: 0, shield: false, tripleShot: 0 
        }
    }

    function createAsteroidBelt() {
        roids = [];
        for (let i = 0; i < 4 + level; i++) {
            let x, y;
            do { x = Math.floor(Math.random() * canv.width); y = Math.floor(Math.random() * canv.height); } 
            while (distBetweenPoints(ship.x, ship.y, x, y) < 200);
            roids.push(newAsteroid(x, y, Math.ceil(90 / 2)));
        }
    }

    function newAsteroid(x, y, r) {
        return {
            x: x, y: y,
            xv: Math.random() * ROID_SPD / FPS * (Math.random() < 0.5 ? 1 : -1) * (1 + level*0.1),
            yv: Math.random() * ROID_SPD / FPS * (Math.random() < 0.5 ? 1 : -1) * (1 + level*0.1),
            r: r, a: Math.random() * Math.PI * 2, rotVel: (Math.random() - 0.5) * 0.05
        };
    }

    function spawnUFO() {
        if(ufo.active || ship.dead) return;
        ufo.active = true;
        ufo.x = Math.random() < 0.5 ? -50 : canv.width + 50;
        ufo.y = Math.random() * canv.height;
        ufo.xv = (ufo.x < 0 ? 1 : -1) * 100 / FPS;
        ufo.bullets = [];
    }

    function shootLaser() {
        if(paused || ship.dead || ship.frozen) return;
        if (ship.canShoot && ship.lasers.length < 15) {
            ship.lasers.push({ x: ship.x + ship.r * Math.cos(ship.a), y: ship.y + ship.r * Math.sin(ship.a), xv: LASER_SPD * Math.cos(ship.a) / FPS, yv: LASER_SPD * Math.sin(ship.a) / FPS, dist: 0 });
            if(ship.tripleShot > 0) {
                let a1 = ship.a - 0.2; let a2 = ship.a + 0.2; 
                ship.lasers.push({ x: ship.x + ship.r * Math.cos(a1), y: ship.y + ship.r * Math.sin(a1), xv: LASER_SPD * Math.cos(a1) / FPS, yv: LASER_SPD * Math.sin(a1) / FPS, dist: 0 });
                ship.lasers.push({ x: ship.x + ship.r * Math.cos(a2), y: ship.y + ship.r * Math.sin(a2), xv: LASER_SPD * Math.cos(a2) / FPS, yv: LASER_SPD * Math.sin(a2) / FPS, dist: 0 });
            }
            playSound('shoot');
        }
        ship.canShoot = false;
        setTimeout(() => ship.canShoot = true, 200); 
    }

    function hyperSpace() {
        if(paused || ship.dead || ship.frozen) return;
        playSound('hyperspace');
        ship.x = Math.random() * canv.width;
        ship.y = Math.random() * canv.height;
        createParticles(ship.x, ship.y, "#0ff");
    }

    function createParticles(x, y, color) {
        for(let i=0; i<10; i++) particles.push({ x: x, y: y, xv: (Math.random()-0.5)*10, yv: (Math.random()-0.5)*10, life: 1.0, color: color });
    }

    function dropPowerUp(x, y) {
        if(Math.random() > 0.3) return; 
        let type = Math.random() < 0.5 ? 'S' : 'T';
        powerups.push({ x: x, y: y, type: type, life: 600 });
    }

    function distBetweenPoints(x1, y1, x2, y2) { return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)); }

    function update() {
        if(!gameRunning || paused) return;
        frameCount++;

        // Draw Background
        ctx.fillStyle = "black"; ctx.fillRect(0, 0, canv.width, canv.height);
        ctx.fillStyle = "white"; stars.forEach(s => { ctx.globalAlpha = s.alpha; ctx.fillRect(s.x, s.y, s.size, s.size); });
        ctx.globalAlpha = 1.0;

        // --- SHIP LOGIC ---
        if (!ship.dead) {
            document.getElementById("powerup-msg").style.display = (ship.tripleShot-- > 0) ? "block" : "none";

            // Apply Unified Input to Ship
            if(!ship.frozen) {
                if(input.left) ship.rot = -TURN_SPEED / 180 * Math.PI / FPS;
                else if(input.right) ship.rot = TURN_SPEED / 180 * Math.PI / FPS;
                else ship.rot = 0;

                ship.thrusting = input.up;
                ship.reversing = input.down;
            }

            if(ship.frozen) {
                ship.freezeTimer -= 1/FPS;
                if(ship.freezeTimer <= 0) { ship.frozen = false; document.getElementById("frozen-msg").style.display = "none"; }
            } else {
                ship.a += ship.rot;
                ship.x += ship.thrust.x; ship.y += ship.thrust.y;
                
                if(ship.thrusting) {
                    ship.thrust.x += THRUST * Math.cos(ship.a) / FPS; 
                    ship.thrust.y += THRUST * Math.sin(ship.a) / FPS;
                    if(ship.blinkNum % 2 == 0) playSound('thrust');
                } else if(ship.reversing) {
                    ship.thrust.x -= (THRUST * 2.0) * Math.cos(ship.a) / FPS; 
                    ship.thrust.y -= (THRUST * 2.0) * Math.sin(ship.a) / FPS;
                } else {
                    ship.thrust.x -= FRICTION * ship.thrust.x / FPS; 
                    ship.thrust.y -= FRICTION * ship.thrust.y / FPS;
                }
            }
            
            // Wrap
            if (ship.x < -20) ship.x = canv.width + 20; else if (ship.x > canv.width + 20) ship.x = -20;
            if (ship.y < -20) ship.y = canv.height + 20; else if (ship.y > canv.height + 20) ship.y = -20;

            // Draw
            if(ship.blinkNum > 0) { ship.blinkTime--; if(ship.blinkTime == 0) { ship.blinkTime = Math.ceil(0.1*FPS); ship.blinkNum--; } }
            
            if(ship.blinkNum % 2 == 0) {
                ctx.save(); ctx.translate(ship.x, ship.y); ctx.rotate(ship.a + Math.PI/2);
                ctx.drawImage(shipImg, -20, -20, 40, 40);
                if(ship.shield && frameCount % 20 < 10) { 
                    ctx.strokeStyle = "#FFD700"; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(0,0, 30, 0, Math.PI*2); ctx.stroke(); 
                }
                ctx.restore();
                // Ice
                if(ship.frozen) {
                    ctx.save(); ctx.translate(ship.x, ship.y);
                    ctx.fillStyle = "rgba(150, 230, 255, 0.6)"; ctx.strokeStyle = "white"; ctx.lineWidth = 2;
                    ctx.beginPath();
                    let shiver = () => (Math.random() - 0.5) * 3;
                    ctx.moveTo(-30+shiver(), -35+shiver()); ctx.lineTo(30+shiver(), -30+shiver());
                    ctx.lineTo(35+shiver(), 35+shiver()); ctx.lineTo(-30+shiver(), 30+shiver());
                    ctx.closePath(); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.strokeStyle = "rgba(255,255,255,0.7)"; ctx.lineWidth=1;
                    ctx.moveTo(-15, -15); ctx.lineTo(-5, -5); ctx.moveTo(10, 10); ctx.lineTo(20, 20); ctx.stroke();
                    ctx.restore();
                }
            }
        }

        // --- ENTITIES ---
        for(let i=powerups.length-1; i>=0; i--) {
            let p = powerups[i];
            ctx.fillStyle = p.type == 'S' ? '#00f' : '#ff0';
            ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font = "bold 12px Arial"; ctx.textAlign="center"; ctx.fillText(p.type, p.x, p.y+4);
            p.life--;
            if(!ship.dead && distBetweenPoints(ship.x, ship.y, p.x, p.y) < ship.r + 10) {
                if(p.type == 'S') ship.shield = true;
                if(p.type == 'T') ship.tripleShot = 600; 
                playSound('powerup'); powerups.splice(i, 1); continue;
            }
            if(p.life <= 0) powerups.splice(i, 1);
        }

        ctx.fillStyle = "#0ff";
        for (let i = ship.lasers.length - 1; i >= 0; i--) {
            let l = ship.lasers[i];
            ctx.beginPath(); ctx.arc(l.x, l.y, 4, 0, Math.PI*2); ctx.fill();
            l.x += l.xv; l.y += l.yv; 
            if (l.x < 0 || l.x > canv.width || l.y < 0 || l.y > canv.height) ship.lasers.splice(i, 1);
        }

        if(!ufo.active && Math.random() < 0.002) spawnUFO();
        if(ufo.active) {
            ctx.drawImage(ufoImg, ufo.x - 25, ufo.y - 15, 50, 30);
            ufo.x += ufo.xv;
            if(ufo.x < -100 || ufo.x > canv.width + 100) ufo.active = false;
            if(Math.random() < 0.01) {
                let ang = (Math.random() < 0.6) ? Math.atan2(ship.y - ufo.y, ship.x - ufo.x) : Math.random() * Math.PI * 2;
                ufo.bullets.push({ x: ufo.x, y: ufo.y, xv: 300*Math.cos(ang)/FPS, yv: 300*Math.sin(ang)/FPS });
                playSound('shoot');
            }
            if(!ship.dead && ship.blinkNum == 0 && distBetweenPoints(ship.x, ship.y, ufo.x, ufo.y) < ship.r + 20) {
                createParticles(ufo.x, ufo.y, "red"); ufo.active = false;
                if(ship.shield) { ship.shield = false; playSound('bang'); } else playerHit();
            }
            for(let i=ship.lasers.length-1; i>=0; i--) {
                if(distBetweenPoints(ship.lasers[i].x, ship.lasers[i].y, ufo.x, ufo.y) < 30) {
                    ship.lasers.splice(i, 1); createParticles(ufo.x, ufo.y, "red"); ufo.active = false; playSound('bang'); score += 500; updateScore(); break;
                }
            }
        }
        
        ctx.fillStyle = "#0f0";
        for(let i=ufo.bullets.length-1; i>=0; i--) {
            let b = ufo.bullets[i]; ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();
            b.x += b.xv; b.y += b.yv;
            if(!ship.dead && !ship.frozen && ship.blinkNum == 0 && distBetweenPoints(ship.x, ship.y, b.x, b.y) < 25) {
                if(ship.shield) { ship.shield = false; ufo.bullets.splice(i, 1); playSound('bang'); }
                else { ship.frozen = true; ship.freezeTimer = 3; document.getElementById("frozen-msg").style.display = "block"; ufo.bullets.splice(i, 1); }
            }
        }

        for(let i=roids.length-1; i>=0; i--) {
            let r = roids[i];
            ctx.save(); ctx.translate(r.x, r.y); ctx.rotate(r.a); ctx.drawImage(roidImg, -r.r, -r.r, r.r*2, r.r*2); ctx.restore();
            r.x += r.xv; r.y += r.yv; r.a += r.rotVel;
            if (r.x < -50) r.x = canv.width + 50; else if (r.x > canv.width + 50) r.x = -50;
            if (r.y < -50) r.y = canv.height + 50; else if (r.y > canv.height + 50) r.y = -50;

            if(!ship.dead && ship.blinkNum == 0 && distBetweenPoints(ship.x, ship.y, r.x, r.y) < ship.r*0.8 + r.r*0.8) {
                if(ship.shield) { ship.shield = false; destroyRoid(i); } else playerHit();
            }
            for(let j=ship.lasers.length-1; j>=0; j--) {
                if(distBetweenPoints(r.x, r.y, ship.lasers[j].x, ship.lasers[j].y) < r.r) {
                    ship.lasers.splice(j, 1); destroyRoid(i); break;
                }
            }
        }

        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i]; ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, 3, 3);
            p.x += p.xv; p.y += p.yv; p.life -= 0.05; if(p.life <= 0) particles.splice(i, 1);
        } ctx.globalAlpha = 1.0;

        if(lives <= 0) {
            ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.font = "40px Arial"; ctx.fillText("GAME OVER", canv.width/2, canv.height/2);
            ctx.font = "20px Arial"; ctx.fillText("Tap to Restart", canv.width/2, canv.height/2+40);
            if(input.left || input.right || input.up || input.down) newGame(); 
        }
        requestAnimationFrame(update);
    }

    function destroyRoid(i) {
        let x = roids[i].x, y = roids[i].y, r = roids[i].r;
        createParticles(x, y, "#aaa"); dropPowerUp(x, y);
        roids.splice(i, 1); playSound('bang'); score += 100;
        if (r > 45) { roids.push(newAsteroid(x, y, r/2)); roids.push(newAsteroid(x, y, r/2)); }
        if(roids.length == 0) { level++; createAsteroidBelt(); }
        updateScore();
    }

    function playerHit() {
        createParticles(ship.x, ship.y, "red"); playSound('bang');
        lives--; document.getElementById("livesEl").innerText = lives;
        if(lives > 0) ship = newShip(); else ship.dead = true;
    }

    function updateScore() { document.getElementById("scoreEl").innerText = score; }
    
    function resizeCanvas() {
        canv.width = window.innerWidth;
        canv.height = window.innerHeight;
        stars = []; 
        for(let i=0; i<100; i++) stars.push({x: Math.random()*canv.width, y: Math.random()*canv.height, size: Math.random()*2, alpha: Math.random()});
    }
    window.addEventListener('resize', resizeCanvas);

</script>
</body>
</html>